<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ID Photo DIY – Professional Document Photo Tool</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  /* 样式完全沿用原文，无改动 */
  :root{
    --md-primary: #1976d2;
    --md-primary-dark: #1565c0;
    --md-primary-light: #e3f2fd;
    --md-surface: #ffffff;
    --md-bg: #f6f7fb;
    --md-text: #1f1f1f;
    --md-text-secondary: #6b7280;
    --md-divider: #e5e7eb;
    --radius: 16px;
    --radius-sm: 8px;
    --shadow-1: 0 2px 8px rgba(0,0,0,.08);
    --shadow-2: 0 10px 30px rgba(0,0,0,.10);
    --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;font-family:'Roboto',-apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif;
    background:var(--md-bg);color:var(--md-text);line-height:1.5;
  }
  header{position:sticky;top:0;z-index:10;
    background:linear-gradient(135deg,var(--md-surface) 85%,#f1f6fd 100%);
    box-shadow:0 2px 8px rgba(0,0,0,.06);backdrop-filter:blur(10px);
    border-bottom:1px solid var(--md-divider);}
  .appbar{max-width:1200px;margin:0 auto;height:64px;display:flex;align-items:center;gap:16px;padding:0 20px;}
  .brand{display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:.2px;font-size:18px;}
  .brand .logo{width:36px;height:36px;border-radius:10px;
    background:linear-gradient(45deg,var(--md-primary),#42a5f5);
    display:flex;align-items:center;justify-content:center;color:white;
    box-shadow:0 2px 6px rgba(25,118,210,.4);}
  .bar-spacer{flex:1}
  main{max-width:1200px;margin:24px auto;padding:0 20px;}
  .grid{display:grid;grid-template-columns:340px 1fr;gap:24px;align-items:start;}
  @media (max-width:960px){.grid{grid-template-columns:1fr}}
  .card{background:var(--md-surface);border-radius:var(--radius);box-shadow:var(--shadow-2);overflow:hidden;transition:var(--transition);}
  .card:hover{box-shadow:0 15px 35px rgba(0,0,0,.12);transform:translateY(-2px);}
  .card-header{padding:18px 24px;border-bottom:1px solid var(--md-divider);
    display:flex;align-items:center;gap:10px;background:var(--md-primary-light);border-top:3px solid var(--md-primary);}
  .card-title{font-weight:600;color:var(--md-primary);display:flex;align-items:center;gap:8px;}
  .card-body{padding:24px}
  .editor-card-body{position:relative;}
  .dropzone{border:2px dashed var(--md-divider);border-radius:var(--radius);padding:32px 22px;text-align:center;color:var(--md-text-secondary);transition:var(--transition);cursor:pointer;
    background-size:200% 200%;background-image:linear-gradient(135deg,#fff 0%,#fbfdff 50%,#f4f8ff 100%);}
  .dropzone:hover{border-color:var(--md-primary);transform:translateY(-4px) scale(1.02);box-shadow:0 8px 20px rgba(25,118,210,.1);}
  .dropzone .material-icons{font-size:42px;color:var(--md-primary);margin-bottom:12px;}
  #file-input{display:none}
  .cropper-shell{width:100%;height:420px;background:#eef1f6;border-radius:var(--radius);overflow:hidden;display:flex;align-items:center;justify-content:center;border:1px solid var(--md-divider);box-shadow:inset 0 2px 4px rgba(0,0,0,0.05);}
  .cropper-shell img{max-width:100%;display:block}
  .thumbs{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:20px;}
  .thumb{background:#f8fafd;border:1px solid var(--md-divider);border-radius:var(--radius);padding:16px;transition:var(--transition);}
  .thumb:hover{box-shadow:var(--shadow-1);transform:translateY(-2px);}
  .thumb h4{margin:0 0 12px;font-size:14px;color:#374151;font-weight:600;display:flex;align-items:center;gap:6px;}
  .thumb-box{height:160px;background:#fff;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid var(--md-divider);box-shadow:0 2px 6px rgba(0,0,0,0.05);}
  .thumb-box img,.thumb-box canvas{width:100%;height:100%;object-fit:contain;}
  .control-group{margin-bottom:20px;}
  label{display:flex;align-items:center;gap:6px;font-size:14px;color:#374151;font-weight:600;}
  select,input[type="text"],input[type="number"]{width:100%;padding:14px 16px;border:1px solid var(--md-divider);border-radius:var(--radius-sm);background:#fff;outline:none;font-size:15px;transition:var(--transition);}
  select:focus,input[type="text"]:focus,input[type="number"]:focus{border-color:var(--md-primary);box-shadow:0 0 0 3px rgba(25,118,210,.12)}
  .sliders{background:#f9fafc;border-radius:var(--radius);margin:20px 0;border:1px solid var(--md-divider);padding:8px 0;}
  .slider-container{padding:16px 20px;display:grid;grid-template-columns:100px 1fr 65px;gap:16px;align-items:center;transition:background-color .2s}
  .slider-container:hover{background-color:#f4f6f9;}
  .slider-container+.slider-container{border-top:1px solid var(--md-divider);}
  .control-label{display:flex;align-items:center;gap:10px;font-size:14px;font-weight:600;color:var(--md-text);}
  .control-label .icon-bg{display:flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:var(--radius-sm);background-color:var(--md-primary-light);color:var(--md-primary);}
  .slider-wrapper{position:relative;height:6px;}
  .slider{-webkit-appearance:none;width:100%;position:absolute;top:0;left:0;height:6px;border-radius:999px;background:var(--md-divider);outline:none;margin:0;}
  .slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;border-radius:50%;background:var(--md-primary);border:none;box-shadow:0 2px 6px rgba(0,0,0,.2);cursor:pointer;transition:var(--transition);}
  .slider::-webkit-slider-thumb:hover{transform:scale(1.15);box-shadow:0 3px 8px rgba(0,0,0,.3);}
  .slider-fill{height:6px;background:var(--md-primary);border-radius:999px;width:var(--slider-fill,50%);pointer-events:none;}
  .input-wrapper{display:flex;align-items:center;gap:4px;border:1px solid var(--md-divider);border-radius:var(--radius-sm);padding:4px 8px;background-color:#fff;transition:var(--transition);}
  .input-wrapper:focus-within{border-color:var(--md-primary);box-shadow:0 0 0 3px rgba(25,118,210,.12);}
  .manual-input{width:100%;min-width:60px;border:none;outline:none;text-align:right;font-size:14px;background:transparent;}
  .manual-input::-webkit-outer-spin-button,.manual-input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
  .manual-input{-moz-appearance:textfield;}
  .actions{display:flex;flex-wrap:wrap;gap:12px;margin-top:20px;}
  .btn{border:none;border-radius:999px;padding:12px 24px;font-weight:600;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;gap:8px;transition:var(--transition);}
  .btn-primary{background:linear-gradient(45deg,var(--md-primary),#42a5f5);color:#fff;box-shadow:0 3px 8px rgba(25,118,210,.3);}
  .btn-primary:hover{background:linear-gradient(45deg,var(--md-primary-dark),var(--md-primary));transform:translateY(-2px);box-shadow:0 5px 12px rgba(25,118,210,.4);}
  .btn-tonal{background:#e8f0fe;color:#0f172a;}
  .btn-tonal:hover{background:#dfeafd;transform:translateY(-2px);}
  .helper{font-size:13px;color:var(--md-text-secondary);line-height:1.5;margin-top:8px;}
  .helper.with-icon{display:flex;align-items:center;gap:6px;}
  footer{padding:32px 0;text-align:center;color:var(--md-text-secondary);font-size:13px;margin-top:40px;}
  .cropper-container .cropper-canvas img,.cropper-container .cropper-view-box img{filter:var(--editor-filter,none);will-change:filter;}
  .material-icons{font-size:18px;}
  .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(100px);background:#323232;color:white;padding:12px 24px;border-radius:999px;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.25);z-index:1000;opacity:0;transition:all .5s cubic-bezier(.16,1,.3,1);}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
  .editor-overlay{position:absolute;inset:0;background:rgba(255,255,255,.7);backdrop-filter:blur(5px);z-index:5;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;color:var(--md-text);padding:20px;border-radius:var(--radius);transition:opacity .4s;opacity:1;pointer-events:all;}
  .editor-overlay.hidden{opacity:0;pointer-events:none;}
  .editor-overlay .material-icons{font-size:48px;color:var(--md-primary);}
  /* ---------- 自定义规格输入区 ---------- */
  #custom-box{display:none;margin-top:12px;gap:12px;flex-wrap:wrap;}
  #custom-box.active{display:flex;}
  .custom-opt{flex:1 1 220px;display:flex;flex-direction:column;gap:6px;}
  .custom-opt label{font-size:13px;font-weight:600;}
</style>
</head>
<body>
<header>
  <div class="appbar">
    <div class="brand">
      <div class="logo"><span class="material-icons">photo_camera</span></div>
      <span>ID Photo DIY – Professional Document Photo Tool</span>
    </div>
    <div class="bar-spacer"></div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="material-icons">collections</span>
          File & Thumbnails
        </div>
      </div>
      <div class="card-body">
        <div id="upload-view" class="dropzone">
          <span class="material-icons">cloud_upload</span>
          <div style="font-weight:600;margin-bottom:8px;">Click or drag to upload image</div>
          <div class="helper with-icon"><span class="material-icons">info</span>Supports JPG / PNG; crop & adjust brightness/contrast/saturation after upload.</div>
        </div>
        <input accept="image/jpeg,image/png" id="file-input" type="file"/>

        <div class="control-group" style="margin-top:20px;">
          <label for="rename-input"><span class="material-icons">drive_file_rename_outline</span> Rename (no extension)</label>
          <input id="rename-input" type="text" placeholder="e.g. my_passport_photo"/>
          <div class="helper with-icon"><span class="material-icons">help_outline</span> Used for filename when downloading; leave blank to keep original.</div>
        </div>

        <div class="thumbs">
          <div class="thumb">
            <h4><span class="material-icons">image</span>Original Thumb</h4>
            <div class="thumb-box"><img id="original-thumb" alt="original thumb"/></div>
          </div>
          <div class="thumb">
            <h4><span class="material-icons">adjust</span>Live Preview</h4>
            <div class="thumb-box"><canvas id="preview-thumb" width="200" height="140"></canvas></div>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title">
          <span class="material-icons">tune</span>
          Edit & Export
        </div>
      </div>
      <div class="card-body editor-card-body">
        <div id="editor-overlay" class="editor-overlay">
          <span class="material-icons">image_search</span>
          <h3 style="margin:16px 0 8px;">Please upload an image first</h3>
          <p style="color:var(--md-text-secondary);font-size:14px;max-width:280px;">Upload a photo from the left panel, then crop & adjust parameters here.</p>
        </div>

        <div class="cropper-shell"><img id="image-to-crop" alt="image to crop"/></div>

        <!-- 规格选择 -->
        <div class="control-group" style="margin-top:20px;">
          <label for="spec-select"><span class="material-icons">photo_size_select_large</span> Photo size template</label>
          <select id="spec-select">
            <option value="1/1">1:1 Square</option>
            <option value="2/3">2:3 Ratio</option>
            <option value="3/4">3:4 Ratio</option>

            <!-- 欧美国家主流证件照 -->
            <optgroup label="United States">
              <option value="1/1.25">US Passport 2×2 in (51×51 mm)</option>
              <option value="1/1.25">US Visa 2×2 in (51×51 mm)</option>
              <option value="1/1.25">US Green Card 2×2 in (51×51 mm)</option>
            </optgroup>
            <optgroup label="Canada">
              <option value="1.3/1.7">Canada Passport 50×70 mm</option>
              <option value="1.3/1.7">Canada Visa 35×45 mm</option>
              <option value="1.3/1.7">Canada PR 35×45 mm</option>
            </optgroup>
            <optgroup label="United Kingdom">
              <option value="1/1.29">UK Passport 35×45</option>
            </optgroup>
            <optgroup label="European Union / Schengen">
              <option value="35/45">EU / Schengen Passport 35×45 mm</option>
              <option value="35/45">EU ID Card 35×45 mm</option>
              <option value="35/45">EU Visa 35×45 mm</option>
            </optgroup>
            <optgroup label="Australia">
              <option value="35/45">Australia Passport 35×45 mm</option>
              <option value="35/45">Australia Visa 35×45 mm</option>
            </optgroup>
            <optgroup label="New Zealand">
              <option value="35/45">NZ Passport 35×45 mm</option>
              <option value="35/45">NZ Visa 35×45 mm</option>
            </optgroup>
            <optgroup label="Ireland">
              <option value="35/45">Ireland Passport 35×45 mm</option>
              <option value="35/45">Ireland Visa 35×45 mm</option>
            </optgroup>
            <optgroup label="Switzerland & Norway">
              <option value="35/45">CH / NO Passport 35×45 mm</option>
              <option value="35/45">CH / NO Visa 35×45 mm</option>
            </optgroup>
            <optgroup label="Custom">
              <option value="custom">Custom…</option>
            </optgroup>
          </select>
        </div>

        <!-- 自定义输入区（已去掉宽高比，只留 mm 输入） -->
        <div id="custom-box">
          <div class="custom-opt">
            <label>Exact size (mm) – W × H</label>
            <div class="cm-row" style="display:flex;gap:8px;">
              <input id="custom-w-mm" type="number" step="1" placeholder="Width (mm)">
              <span>×</span>
              <input id="custom-h-mm" type="number" step="1" placeholder="Height (mm)">
            </div>
          </div>
        </div>

        <!-- 调整滑块 -->
        <div class="sliders">
          <div class="slider-container">
            <div class="control-label">
              <span class="icon-bg"><span class="material-icons">brightness_medium</span></span>
              <span>Brightness</span>
            </div>
            <div class="slider-wrapper">
              <div class="slider-fill" id="brightness-fill"></div>
              <input type="range" id="brightness" class="slider" min="0" max="200" value="100">
            </div>
            <div class="input-wrapper">
              <input type="number" id="brightness-input" class="manual-input" min="0" max="200" value="100">
              <span>%</span>
            </div>
          </div>
          <div class="slider-container">
            <div class="control-label">
              <span class="icon-bg"><span class="material-icons">contrast</span></span>
              <span>Contrast</span>
            </div>
            <div class="slider-wrapper">
              <div class="slider-fill" id="contrast-fill"></div>
              <input type="range" id="contrast" class="slider" min="0" max="200" value="100">
            </div>
            <div class="input-wrapper">
              <input type="number" id="contrast-input" class="manual-input" min="0" max="200" value="100">
              <span>%</span>
            </div>
          </div>
          <div class="slider-container">
            <div class="control-label">
              <span class="icon-bg"><span class="material-icons">invert_colors</span></span>
              <span>Saturation</span>
            </div>
            <div class="slider-wrapper">
              <div class="slider-fill" id="saturation-fill"></div>
              <input type="range" id="saturation" class="slider" min="0" max="200" value="100">
            </div>
            <div class="input-wrapper">
              <input type="number" id="saturation-input" class="manual-input" min="0" max="200" value="100">
              <span>%</span>
            </div>
          </div>
        </div>

        <!-- 导出格式 -->
        <div class="control-group">
          <label for="format-select"><span class="material-icons">folder</span> Export format</label>
          <select id="format-select">
            <option value="original">Keep original</option>
            <option value="image/jpeg">JPG</option>
            <option value="image/png">PNG</option>
            <option value="image/webp">WebP</option>
          </select>
        </div>

        <!-- 按钮区 -->
        <div class="actions">
          <button class="btn btn-tonal" id="reset-btn">
            <span class="material-icons">restart_alt</span> Reset
          </button>
          <button class="btn btn-primary" id="crop-download-btn">
            <span class="btn-content">
              <span class="material-icons">download</span> Finish & Download
            </span>
          </button>
        </div>

        <p class="helper with-icon" style="margin-top:16px;">
          <span class="material-icons">lightbulb_outline</span>
          Tip: mouse-wheel to zoom, drag to move; resize crop box freely.
        </p>
      </div>
    </section>
  </div>
</main>

<footer>Copyright © 2025 Idphotodiy. All rights reserved.</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
/* ---------- 以下脚本与上一段完全连续，仅移除 customRatio 相关 ---------- */
const $  = q => document.querySelector(q);
const $$ = q => document.querySelectorAll(q);

/* ---- DOM ---- */
const uploadView   = $('#upload-view');
const fileInput    = $('#file-input');
const imageToCrop  = $('#image-to-crop');
const resetBtn     = $('#reset-btn');
const specSel      = $('#spec-select');
const cropBtn      = $('#crop-download-btn');
const brightS      = $('#brightness');
const contrastS    = $('#contrast');
const saturateS    = $('#saturation');
const brightF      = $('#brightness-fill');
const contrastF    = $('#contrast-fill');
const saturateF    = $('#saturation-fill');
const brightI      = $('#brightness-input');
const contrastI    = $('#contrast-input');
const saturateI    = $('#saturation-input');
const formatSel    = $('#format-select');
const renameInput  = $('#rename-input');
const origThumb    = $('#original-thumb');
const previewCv    = $('#preview-thumb');
const previewCtx   = previewCv.getContext('2d');
const overlay      = $('#editor-overlay');
const customBox    = $('#custom-box');
const customWmm    = $('#custom-w-mm');
const customHmm    = $('#custom-h-mm');

/* ---- state ---- */
let cropper = null, originalFile = null, originalURL = null, rafToken = null;

/* ---- util ---- */
function parseRatio(str) {
  const [w, h] = String(str).split('/').map(Number);
  return (w > 0 && h > 0) ? w / h : NaN;
}
function currentFilter() {
  const b = brightS.value / 100, c = contrastS.value / 100, s = saturateS.value / 100;
  return `brightness(${b}) contrast(${c}) saturate(${s})`;
}
function showToast(msg) {
  const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg;
  document.body.appendChild(t); setTimeout(() => t.classList.add('show'), 10);
  setTimeout(() => { t.classList.remove('show'); t.addEventListener('transitionend', () => t.remove()); }, 2500);
}
function updateSliderFill(slider, fill) {
  const p = (slider.value - slider.min) / (slider.max - slider.min) * 100;
  fill.style.setProperty('--slider-fill', `${p}%`);
}
function resetSliders() {
  [brightS, contrastS, saturateS].forEach(s => s.value = 100);
  [brightI, contrastI, saturateI].forEach(i => i.value = 100);
  updateSliderFill(brightS, brightF); updateSliderFill(contrastS, contrastF); updateSliderFill(saturateS, saturateF);
  applyAdj();
}
function applyAdj() {
  const container = document.querySelector('.cropper-container');
  const fs = currentFilter();
  if (container) container.style.setProperty('--editor-filter', fs);
  else imageToCrop.style.filter = fs;
  reqThumb();
}
function reqThumb() { if (rafToken) return; rafToken = requestAnimationFrame(updateThumb); }
function updateThumb() {
  rafToken = null; if (!cropper) return;
  const canvas = cropper.getCroppedCanvas({ width: 400, fillColor: '#fff' }); if (!canvas) return;
  const maxW = previewCv.width, maxH = previewCv.height;
  let dw = canvas.width, dh = canvas.height, ratio = Math.min(maxW / dw, maxH / dh);
  dw = Math.max(1, Math.floor(dw * ratio)); dh = Math.max(1, Math.floor(dh * ratio));
  previewCtx.clearRect(0, 0, maxW, maxH); previewCtx.save(); previewCtx.filter = currentFilter();
  previewCtx.drawImage(canvas, (maxW - dw) / 2, (maxH - dh) / 2, dw, dh); previewCtx.restore();
}

/* ---- cropper ---- */
function getCurrentAspectRatio() {
  if (specSel.value !== 'custom') return parseRatio(specSel.value);
  // 只根据输入的 mm 值计算宽高比
  const w = parseFloat(customWmm.value), h = parseFloat(customHmm.value);
  return (w > 0 && h > 0) ? w / h : NaN;
}
function initCropper() {
  if (cropper) cropper.destroy();
  const ar = getCurrentAspectRatio();
  cropper = new Cropper(imageToCrop, {
    aspectRatio: isNaN(ar) ? NaN : ar,
    viewMode: 1, autoCropArea: 0.8, dragMode: 'move',
    guides: true, center: true, background: false,
    cropBoxMovable: true, cropBoxResizable: true,
    ready() { applyAdj(); reqThumb(); overlay.classList.add('hidden'); },
    crop() { reqThumb(); }
  });
}

/* ---- events ---- */
uploadView.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const f = e.target.files?.[0]; if (!f) return;
  originalFile = f; const r = new FileReader();
  r.onload = ev => {
    originalURL = ev.target.result;
    imageToCrop.src = originalURL;
    origThumb.src = originalURL;
    const dot = f.name.lastIndexOf('.'); renameInput.value = dot > -1 ? f.name.slice(0, dot) : f.name;
    initCropper();
  }; r.readAsDataURL(f);
});
specSel.addEventListener('change', () => {
  const isCustom = specSel.value === 'custom';
  customBox.classList.toggle('active', isCustom);
  if (cropper) { cropper.setAspectRatio(getCurrentAspectRatio()); reqThumb(); }
});
[customWmm, customHmm].forEach(el =>
  el.addEventListener('input', () => { if (cropper) { cropper.setAspectRatio(getCurrentAspectRatio()); reqThumb(); } })
);

/* ---- sliders ---- */
brightS .addEventListener('input', e => { brightI.value = e.target.value; updateSliderFill(brightS, brightF); applyAdj(); });
brightI .addEventListener('input', e => { const v = Math.max(0, Math.min(200, parseInt(e.target.value) || 0)); brightS.value = v; updateSliderFill(brightS, brightF); applyAdj(); });
contrastS.addEventListener('input', e => { contrastI.value = e.target.value; updateSliderFill(contrastS, contrastF); applyAdj(); });
contrastI.addEventListener('input', e => { const v = Math.max(0, Math.min(200, parseInt(e.target.value) || 0)); contrastS.value = v; updateSliderFill(contrastS, contrastF); applyAdj(); });
saturateS.addEventListener('input', e => { saturateI.value = e.target.value; updateSliderFill(saturateS, saturateF); applyAdj(); });
saturateI.addEventListener('input', e => { const v = Math.max(0, Math.min(200, parseInt(e.target.value) || 0)); saturateS.value = v; updateSliderFill(saturateS, saturateF); applyAdj(); });

resetBtn.addEventListener('click', () => { resetSliders(); if (cropper) cropper.reset(); });

/* ---- download ---- */
cropBtn.addEventListener('click', () => {
  if (!cropper || !originalFile) { showToast('Please upload an image first'); return; }
  const btnContent = cropBtn.querySelector('.btn-content');
  const origHTML = btnContent.innerHTML;
  btnContent.innerHTML = '<div class="loading"></div> Processing…'; cropBtn.disabled = true;
  setTimeout(() => {
    const cropped = cropper.getCroppedCanvas({ width: 800, fillColor: '#fff' });
    const temp = document.createElement('canvas'); const ctx = temp.getContext('2d');
    temp.width = cropped.width; temp.height = cropped.height; ctx.filter = currentFilter(); ctx.drawImage(cropped, 0, 0);
    let mime = formatSel.value, quality = 0.95;
    if (mime === 'original') mime = originalFile.type || 'image/jpeg';
    if (mime === 'image/png') quality = 1;
    const base = (renameInput.value || '').trim() || (originalFile.name.includes('.') ? originalFile.name.slice(0, originalFile.name.lastIndexOf('.')) : originalFile.name);
    let ext = 'jpg'; if (mime === 'image/png') ext = 'png'; else if (mime === 'image/webp') ext = 'webp';
    const link = document.createElement('a'); link.href = temp.toDataURL(mime, quality); link.download = `${base}_id_photo.${ext}`;
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
    btnContent.innerHTML = origHTML; cropBtn.disabled = false; showToast('Download started');
  }, 100);
});

/* ---- drag & drop ---- */
['dragover', 'dragleave', 'drop'].forEach(evt => {
  uploadView.addEventListener(evt, e => {
    e.preventDefault(); if (evt === 'dragover') { uploadView.style.borderColor = 'var(--md-primary)'; uploadView.style.transform = 'translateY(-4px) scale(1.02)'; }
    else if (evt === 'dragleave') { uploadView.style.borderColor = 'var(--md-divider)'; uploadView.style.transform = 'translateY(0) scale(1)'; }
    else if (evt === 'drop') { uploadView.style.borderColor = 'var(--md-divider)'; uploadView.style.transform = 'translateY(0) scale(1)';
      const fs = e.dataTransfer.files; if (fs?.length) { fileInput.files = fs; fileInput.dispatchEvent(new Event('change')); } }
  });
});

/* ---- init ---- */
document.addEventListener('DOMContentLoaded', () => {
  updateSliderFill(brightS, brightF); updateSliderFill(contrastS, contrastF); updateSliderFill(saturateS, saturateF);
});
</script>
</body>
</html>
